<include file="Public/header" />
<!-- content part -->
<div class="content" style='background: #ecf0f5;'>
<include file="Public/nav" />
	<!-- 内容顶部tab -->
	<div id="hTop">
		<div>
			<span class="h1" id="allincome">0</span>
			<span><b>当月总收入(元)</b></span>
			<!-- <a href="{{:U('Admin/Users/flow')}}" class="headlink">更多</a> -->
		</div>
		<div>
			<span class="h1" id="count">0</span>
			<span><b>订单数量(单)</b></span>
			<!-- <a href="{{:U('Admin/Orders/index')}}" class="headlink">更多</a> -->
		</div>
		<div>
			<span class="h1" id="usernum">0</span>
			<span><b>用户数量(人)</b></span>
			<!-- <a href="{{:U('Admin//Feeds/repairlist')}}" class="headlink">更多</a> -->
		</div>
		<div> 
			<span class="h1" id="deviceNum">0</span>
			<span><b>设备数量(台)</b></span>
			<!-- <a href="{{:U('Admin/Feeds/feedslist')}}" class="headlink">更多</a> -->
		</div>
	</div>
	<div id="hBottom">
		<!-- 折线图 -->
		<div id="bottomLeft">
			<!-- 充值套餐 -->
			<div class='ctitle'>
				<h3>充值套餐</h3>
				<p class='deviceT'>&emsp;</p>
				<div id="income"></div>
				<!-- <p class='xname'>时间（月）</p>
				<p class='yname'>用户数量（人）</p> -->
			</div>
			<!-- 设备连接 -->
			<div class='ctitle'>
				<h3>设备连接</h3>
				<p class='deviceT'>- 本周数据 -</p>
				<div id="newMoreDevice"></div>
			</div>
		</div>
		<!-- 地图 -->
		<div id="map" class='clearfix'>
			<ul class='ctitle'>
				<h3>水机分布</h3>
			</ul>
			<div id="allmap" class='fl'></div>
			<div class='desc fr'>
				<h4>水机分布省份( Top5 )</h4>
				<ul>
					<li>广东&emsp;<span class='top1'>115</span></li>
					<li>浙江&emsp;<span class='top2'>89</span></li>
					<li>四川&emsp;<span class='top3'>54</span></li>
					<li>青海&emsp;<span class='top4'>45</span></li>
					<li>宁夏&emsp;<span class='top5'>30</span></li>
				</ul>
			</div>
		</div>
	</div>
	<script src="__PUBLIC__/Admin/js/echarts.min.js"></script>
	<script>
		$('.content').css({height: window.innerHeight - 30 + 'px'});
		var chinajsonurl = '__PUBLIC__/Admin/map/china.json';
		var date = new Date().getDay();	// 当天日期
		var month = new Date().getMonth()+1;
		var weekArr = [];
		// 最近七天
		// for(var i=6; i>=0; i--){
		// 	weekArr.push(month + '.'+ (date - i));
		// }

		// 每周连接设备集合
		var now = new Date(); 
		var nowTime = now.getTime() ; 
		var day = now.getDay();
		var oneDayTime = 24*60*60*1000 ; 

		//显示周一
		var MondayTime = nowTime - (day-1)*oneDayTime ; 
		//显示周日

		var SundayTime =  nowTime + (7-day)*oneDayTime ; 

		//初始化日期时间
		var monday = new Date(MondayTime);
		var sunday = new Date(SundayTime);
		weekArr.push(monday.getMonth()+1 + '.' + monday.getDate());
		weekArr.push(monday.getMonth()+1 + '.' + (monday.getDate()+1));
		weekArr.push(monday.getMonth()+1 + '.' + (monday.getDate()+2));
		weekArr.push(monday.getMonth()+1 + '.' + (monday.getDate()+3));
		weekArr.push(monday.getMonth()+1 + '.' + (monday.getDate()+4));
		weekArr.push(monday.getMonth()+1 + '.' + (monday.getDate()+5));
		weekArr.push(monday.getMonth()+1 + '.' + (monday.getDate()+6));

		function getData(callback){
			// 获取统计数据
			$.ajax({
				url: "{{:U('Admin/Index/index')}}",
				type: 'post',
				success: function(res){
					console.log('res: ',res);
					var deviceArr = [];		// 每周新增设备
					var mealArr = [];		// 充值套餐分类统计
					var deviceNum = 0;
					// 遍历每周新增设备数量
					for(var i=1; i<8; i++){
						if(!res.week[i]){
							res.week[i] = {};
							res.week[i]['count'] = 0;
						}
						deviceArr.push(+res.week[i].count);
						deviceNum += res.week[i].count-0;
					}
					// console.log('deviceNum: ',deviceNum);
					// 总收入
					$("#allincome").text(Number(res.money).toFixed(2));
					// 订单数量
					$("#count").text(+res.count);
					// 用户数量
					$("#usernum").text(+res.usercount);
					// 设备数量
					$("#deviceNum").text(+deviceNum);
					console.log('weekArr: ',weekArr);
					// 每周连接设备集合
					console.log('deviceArr: ',deviceArr);
					// 模拟数据
					mealArr = [{
						type: 'A',
						data: [12,345,76,89,36]
					},{
						type: 'B',
						data: [22,45,176,589,336]
					},{
						type: 'C',
						data: [82,145,726,189,236]
					}]
					// 回调函数
					callback([mealArr, deviceArr]);
				},
				error: function(err){
					console.log('err: ',err);
				}
			})
		}

	</script>
	<script src="__PUBLIC__/Admin/js/index/index.js"></script>
	<script>
		sessionStorage.setItem('nav_now', '');
		var headlink = $('.headlink');
		// 设置首页点击后的导航定位，高亮
		for(var i=0; i<headlink.length; i++){
			console.log(headlink[i])
			$('.headlink').eq(i).click(function(){
				// console.log($(this))
				sessionStorage.setItem('nav_now', this.getAttribute("href"));
			})
		}

		// echart配置(充值套餐)
		function getOptionMeal(dataArr, callback){
			console.log('dataArr: ',dataArr);
			var colors = ['#ef8646', '#8eef46', '#58f0ee'];
			//subtext,legend_data, yAxis_data, series_data, markName
			callback({
			    color: colors,
			    tooltip: {
			        trigger: 'axis'
			    },
			    legend: {
			        left: 'middle',
			        data: ['A套餐', 'B套餐', 'C套餐']
			    },
			    xAxis: [
			       {
				       	type: 'category',
				        name: '时间\n（月）',
				    	nameTextStyle: {
				    		color: '#666',
				    		// fontSize: '16'
				    	},
				    	axisLabel: {  
						   interval:0,  
						   rotate:40  
						},
				        splitLine: {show: false},
				        data: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
				        axisTick: {	// 刻度线朝内
				        	inside: true,
				        	alignWithLabel: true, 	// 刻度对齐
				        },
				        axisLine: {	// 坐标轴箭头
				            symbol:['none','arrow'],
				            symbolSize: [6,9],
				            symbolOffset: [1300, 0]
				        },
			       }
			    ],
			    yAxis: [
			        {
			            type: 'value',
			            name: '用户数量（人）',
				    	nameTextStyle: {
				    		color: '#666',
				    		// fontSize: '16'
				    	},
			            splitLine:{show: false},//去除网格线,
				        axisLine: {	// 坐标轴箭头
				            symbol:['none','arrow'],
				            symbolSize: [6,9],
				            symbolOffset: [1300, 0]
				        },
				        axisTick: {	// 刻度线朝内
				        	inside: true
				        },
			        }
			    ],
			    series: [
			        {
			            name: 'A套餐',
			            type: 'line',
			            smooth: true,
			            data: dataArr.series_data[0].data
			        },
			        {
			            name: 'B套餐',
			            type: 'line',
			            smooth: true,
			            data: dataArr.series_data[1].data
			        },
			        {
			            name: 'C套餐',
			            type: 'line',
			            smooth: true,
			            data: dataArr.series_data[2].data
			        }
			    ]
			})
		}
		// echart配置(设备连接)
		function getOptionDevice(obj, callback){
			//subtext,legend_data, yAxis_data, series_data, markName
			callback({
			    title: {
			        text: '',
			    },
			    color: '#93aaff',
			    tooltip: {		// 鼠标停顿提示
			        trigger: 'axis'
			    },
			    xAxis:  {
			    	name: '日期',
			    	nameTextStyle: {
			    		color: '#666',
			    		// fontSize: '16'
			    	},
			        type: 'category',
			        data: obj.xData,	//x轴坐标数据
			        axisLine: {	// 坐标轴箭头
			            symbol:['none','arrow'],
			            symbolSize: [6,9],
			            symbolOffset: [0, 300]
			        },
			        axisTick: {	// 刻度线朝内
			        	inside: true,
			        	alignWithLabel: true, 	// 刻度对齐
			        }
			    },
			    yAxis: {
			    	name: '次数',
			    	nameTextStyle: {
			    		color: '#666',
			    		// fontSize: '16'
			    	},
			        type: 'value',
			        offset: 1,
			        boundaryGap: false,
			        axisPointer: {
			            snap: true
			        },
			        axisLine: {	// 坐标轴箭头
			            symbol:['none','arrow'],
			            symbolSize: [6,9],
			            symbolOffset: [1300, 0]
			        },
			        axisTick: {	// 刻度线朝内
			        	inside: true
			        },
			        splitLine:{  
                　　　　show: false
               　　 } 
			    },
			    series: [{
		            data: obj.series_data,
		            type:'line',
		            name: obj.markName,
        			// symbol: 'circle',
        			symbolSize: 10,
		        }],
			})
		}
		var legend_data = ['充值套餐','设备连接'];

		// 充值套餐
		var income = echarts.init(document.querySelector('#income'));
		// 设备连接
		var newMoreDevice = echarts.init(document.querySelector('#newMoreDevice'));

		// 获取统计数据
		getData(function(series_data){
			console.log('series_data: ',series_data);

			if(series_data[0].length){
				//充值套餐 折线图显示
				getOptionMeal({
					legend_data: legend_data[0], 
					series_data: series_data[0], 
					markName: legend_data[0]
				}, function(option){
					console.log('option0: ',option);
					income.setOption(option);
				})
			}else{
				series_data[0] = [0, 0, 0, 0, 0, 0, 0]
				//设备连接 折线图显示
				getOptionMeal({
					legend_data: legend_data[0], 
					series_data: series_data[0], 
					markName: legend_data[0],
					xData: weekArr
				}, function(option){
					console.log('option0: ',option);
					newMoreDevice.setOption(option);
				})
			}
			if(series_data[1].length){
				//设备连接 折线图显示
				getOptionDevice({
					legend_data: legend_data[1], 
					series_data: series_data[1], 
					markName: legend_data[1],
					xData: weekArr
				}, function(option){
					console.log('option1: ',option);
					newMoreDevice.setOption(option);
				})
			}else{
				series_data[1] = [0, 0, 0, 0, 0, 0, 0]
				//设备连接 折线图显示
				getOptionDevice({
					legend_data: legend_data[1], 
					series_data: series_data[1], 
					markName: legend_data[1],
					xData: weekArr
				}, function(option){
					console.log('option1: ',option);
					newMoreDevice.setOption(option);
				})
			}
			
		})
		/*************************  地图  **************************/
		
	</script>
	<script>
		window.onresize = function() {
            location.reload(true);
        }
	</script>
</div>
<include file="Public/footer" />