<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>充值</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
	<link rel="stylesheet" href="__PUBLIC__/Home/amazeui/assets/css/amazeui.min.css">
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/iconfont/iconfont.css">
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/css/common.css">
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/css/index/index.css">
	<script src="__PUBLIC__/Home/js/vue.min.js"></script>
</head>
<body>
	<div id='charge'>
		<ul class='cTop cfix'>
			<li class='fleft'>
				<span class='roundok'>1</span>
				<p>套餐选择</p>
			</li>
			<li class='fleft'>
				<span :class='(mainShow == "info" || mainShow == "done") ? "roundok" : ""'>2</span>
				<p>信息录入</p>
			</li>
			<li class='fleft'>
				<span :class='mainShow == "done" ? "roundok" : ""'>3</span>
				<p>完成充值</p>
			</li>
		</ul>
		<div class='cMain'>
			<!-- 套餐选择 -->
			<ul v-if='mainShow == "meal"' :style='{display: mainShow == "meal" ? "block" : "none"}'>
				<p class='tcenter'><label for="">套餐选择</label></p>
				<li v-for='m in mealList' @click='select_meal' class='meal tcenter' :meal_id='m.meal_id' :money='m.money'>
					<span v-text='m.content'>套餐</span>
				</li>
			</ul>
			<!-- 信息录入 -->
			<ul class='nextul' :style='{display: mainShow == "info" ? "block" : "none"}'>
				<li class='cfix'>
					<label for="">姓名</label>
					<input type="text" name='name' class='uname fright f888' v-model='uname' placeholder="请输入姓名">
				</li>
				<li class='cfix'>
					<label for="">电话</label>
					<input type="text" name='phone' class='uphone fright f888' v-model='uphone' placeholder="请输入手机号码">
				</li>
				<li class='cfix'>
					<label for="" style='vertical-align: top;'>地址</label>
					<span class='uaddr areabtn f888'></span>
					<span class='fright f888 areabtn'>请选择 >&nbsp;</span>
				</li>
				<li class='cfix'>
					<textarea name="addrdetail" class='uaddrdetail fright f888' cols="30" rows="5" placeholder="请输入详细地址，如道路、门牌号、小区、楼栋号、单元室等" v-model='uaddrdetail'></textarea>
				</li>
				<li class='money'>
					<label for="">金额</label><span><span v-text='money'>300元</span>元</span>
				</li>
			</ul>
			<!-- 完成充值 -->
			<ul class='nextul done' :style='{display: mainShow == "done" ? "block" : "none"}'>
				<li class='tcenter'>
					<span class='iconfont icon-chenggong'></span>
					<p class='f888'>恭喜，你已充值成功</p>
				</li>
			</ul>
		</div>
		<footer class='next tcenter' @click='next'>下一步</footer>
		<div id="areaChoose" class="citys">
			<div class="areaChoosebg">&emsp;</div>
	        <div class="areaDiv">
	        	<div class='atop'>
	        		<p>&emsp;</p>
		        	<h2 class='am-h2 am-text-center'>所在地区</h2>
		        	<button type="button" class="am-close close">&times;</button>
				</div>
				<div>
					<div>
						<p class='ptext ltext fblue'>请选择&nbsp;</p>
						<div class='province areadiv' value="440000" data-code="440000"></div>
					</div>
					<div>
						<p class='ctext ltext fblue'>&nbsp;</p>
						<div class="city areadiv" value="440100" data-code="440100"></div>
					</div>
					<div>
						<p class='atext ltext fblue'>&nbsp;</p>
						<div class="area areadiv" value="440103" data-code="440103"></div>
					</div>
				</div>
	    	</div>
	    	<div id="confirmAreaChoose">
	    		<div>确定</div>
	    	</div>
		</div>
	</div>
	<script src="__PUBLIC__/Home/js/public.js"></script>
	<script src="__PUBLIC__/Home/js/jquery.min.js"></script>
	<script src="__PUBLIC__/Home/amazeui/assets/js/amazeui.min.js"></script>
	<script src="__PUBLIC__/Home/js/index/index.js"></script>
	<script src="__PUBLIC__/Home/js/jquery.citys.js"></script>
	<script src="__PUBLIC__/Home/js/jweixin-1.2.0.js"></script>
	<script>

		//微信接口
		wx.config({
			debug: false,
			appId: '{{$weixin["appId"]}}',
			timestamp: '{{$weixin["timestamp"]}}',
			nonceStr: '{{$weixin["nonceStr"]}}',
			signature: '{{$weixin["signature"]}}',
			jsApiList: [
				// 所有要调用的 API 都要加到这个列表中
				'chooseWXPay',
		        'openWXDeviceLib',
		        'closeWXDeviceLib',
		        'getWXDeviceInfos',
		        'getWXDeviceBindTicket',
		        'getWXDeviceUnbindTicket',
		        'startScanWXDevice',
		        'stopScanWXDevice',
		        'connectWXDevice',
		        'disconnectWXDevice',
		        'sendDataToWXDevice',
		        'onWXDeviceBindStateChange',
		        'onWXDeviceStateChange',
		        'onScanWXDeviceResult',
		        'onReceiveDataFromWXDevice',
		        'onWXDeviceBluetoothStateChange',
			]
		});
		// 微信支付方法
		var weixinPay = function (res, callback){
			var type = Object.prototype.toString.call(res);
			if(type === '[object Object]'){
				res = JSON.stringify(res);
			}
			WeixinJSBridge.invoke(
				'getBrandWCPayRequest',
				JSON.parse(res),
				function(res){
					if (res.err_msg.substr(-2) == 'ok') {
						callback({status: 'ok'});
		                // 付款成功，跳转前台主页
		                // location.href = "{{:U('Home/PaymentSystem/paytosuccess_cz')}}";
		            } else if (res.err_msg.substr(-6) == 'cancel') {
						callback({status: 'cancel'});

		                // 取消付款
		                // 跳转到待付款订单页面
		                // location.href = "{{:U('Home/PaymentSystem/paytofailed')}}";
		            }else{
		                // 付款失败
						callback({status: 'failed'});
		                // 跳转到待付款订单页面
		                // location.href = "{{:U('Home/PaymentSystem/paytofailed')}}";
		            }
		        }
		    );
		};	
	</script>
	<script>
		var charge = new Vue({
			el: '#charge',
			data() {
				return {
					href: location.href,
					mealList: [],		//套餐数据
					money: '',			// 充值的套餐金额
					class2: '',			// 流程第二步
					class3: '',			// 流程第三步（走完）
					mainShow: 'meal',	// 显示套餐meal，信息info，还是完成done
					meal_id: '',		// 选择的套餐id
					uname: '',			//用户名
					uphone: '',			// 电话
					uaddr: '',			// 地址
					uaddrdetail: '',	// 详细地址
				}
			},
			watch: {},
			methods: {
				// 选择套餐
				select_meal: function(e){
					var ele = e.currentTarget;
					var meal = document.querySelectorAll('.meal');
					meal.forEach(function(meal, index){
						meal.setAttribute('class', 'meal tcenter');
					});
					// 获取套餐id
					this.meal_id = ele.getAttribute('meal_id');
					// 获取套餐金额
					this.money = ele.getAttribute('money');
					ele.setAttribute('class', 'meal tcenter select');
				},
				// 下一步
				next: function(){
					var that = this;
					if(this.mainShow == 'meal'){
						// 当前为套餐选择界面
						if(!this.meal_id || !this.money){
							noticeFn({text: '请选择套餐!'});
							return
						}
						// 下一步为信息录入
						location.href = this.href + '?info&meal_id=' + this.meal_id + '&money=' + this.money;
					}else if(this.mainShow == 'info'){
						var buyinfo = {};
						buyinfo['meal_id'] = this.meal_id;
						buyinfo['money'] = this.money;
						buyinfo['name'] = this.uname;
						buyinfo['phone'] = this.uphone;
						buyinfo['addr'] = this.uaddr;
						buyinfo['addrdetail'] = this.uaddrdetail;

						// 当前录入信息界面
						var origin = location.origin;
						var pathname = location.pathname;
						if(!this.uname){
							noticeFn({text:'请输入用户名!'});
							$('.uname').css({border: '1px solid red'});
							return
						}else if(!nameCheck(trimFn(this.uname))){
							noticeFn({text:'请输入用户名!'});
							$('.uname').css({border: '1px solid red'});
							return
						}else{
							$('.uname').css({border: 'none'});
						}
						if(!this.uphone){
							noticeFn({text:'请输入手机号!'});
							$('.uphone').css({border: '1px solid red'});
							return
						}else if(!phoneCheck(trimFn(this.uphone))){
							noticeFn({text:'请输入正确的手机号!'});
							$('.uphone').css({border: '1px solid red'});
							return
						}else{
							$('.uphone').css({border: 'none'});
						}
						if(!this.uaddr){
							noticeFn({text:'请选择地址!'});
							return
						}
						if(!this.uaddrdetail){
							noticeFn({text:'请输入详细地址!'});
							$('.uaddrdetail').css({border: '1px solid red'});
							return
						}else{
							$('.uaddrdetail').css({border: 'none'});
						}
						// 发送客户信息和订单信息，让后台生成订单号
						that.getOrderid(buyinfo, function(orderid){
							// 订单生成成功
							if(orderid){
								// 查询订单信息是否保存, 并接收后台返回的用于 支付的数据
								that.checkOrderid(orderid, function(res){
									if(res == -1){
										noticeFn({text: '支付出错， 请稍后再试！'});
									}else{
										// 微信支付
										weixinPay(res, function(res){
											if(res.status === 'ok'){
												// 支付成功
											}else if(res.status === 'cancel'){
												// 取消支付
											}else if(res.status === 'failed'){
												// 支付失败
											}
										})
									}
								})
							}
							// 下一步为完成
							location.href = origin + pathname + '?done';
						})
					}
				},
				// 获取套餐数据
				getMeal: function(){
					// 套餐数据
					this.mealList = [
						{meal_id: 1, content: '100元/100天', money:'100'},
						{meal_id: 2, content: '300元/300天', money:'300'},
						{meal_id: 3, content: '500元/500天', money:'500'}
					];
				},
				// 获取订单号（后台生成，用于微信支付）
				getOrderid: function(buyinfo, callback){
					$.ajax({
						url: '',
						type: 'post',
						data: buyinfo,
						success: function(res){
							console.log('res: ',res);
							callback(res.orderid);
						},
						error: function(err){
							console.log('err: ',err);
							callback(err);
						}
					})
				},
				// 查询订单信息
				checkOrderid: function(orderid, callback){}
			},
			created() {
				var href = this.href;
				if(href.indexOf('info') > -1){
					var moneyindex = href.indexOf('money=')+6;
					this.money = href.substring(moneyindex);
					this.mainShow = 'info';		// 信息选择

				}else if(href.indexOf('done') > -1){
					this.mainShow = 'done';		// 完成选择
					$('.next').hide();

				}else if(href.indexOf('meal') > -1){
					this.mainShow = 'meal';		// 套餐选择
					this.getMeal();				// 获取套餐信息

				}else{
					this.mainShow = 'meal';		// 套餐选择
					this.getMeal();				// 获取套餐信息
				}
				
			},
			mounted() {
				// var meal2 = document.querySelectorAll('.meal')[1];
				// meal2.setAttribute('class', 'meal tcenter select');
				// // 获取套餐id
				// this.meal_id = meal2.getAttribute('meal_id');
			},
		})
	</script>
	<script>
		
		// 选择地区
		$(".areabtn").on("click", function(){
			$("#areaChoose").fadeIn('fast');
		});

		// 关闭地区选择，并显示到对应区域
		$(".area").on("click", 'p', function(){
			
			var province = $('.ptext').text(),
				city = $('.ctext').text(),
				area = $(this).text();

			if(province && area){
				$('.areabtn').eq(1).hide();
			}else {
				$(".uaddr").text('');
				$('.areabtn').eq(1).show();
			}
			charge.uaddr = province + ' ' + city + ' ' + area;
			$(".uaddr").text( (!province && !city && !area) ? '请选择' : province + ' ' + city + ' ' + area);
			$(".uaddr").css({display:'inline-block'});
			// console.log($(this).text().indexOf('请选择'));
			if($(this).text().indexOf('请选择') == -1){
				setTimeout(function(){
					$("#areaChoose").fadeOut('fast');
					$('.choosebtn').hide();

				},300);
			}

		});
	</script>
</body>
</html>
